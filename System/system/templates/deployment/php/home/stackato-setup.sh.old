
#!/bin/bash

###For Docker Envion
SAR=app

. /opt/mpas/etc/scripts.env 

#####





if test -f ./db.env
 then
echo "reading in db Config"
	. ./db.env
 fi

. ./setup.env

if test -f ./fs.env
 then
echo "reading in fs Config"

        . ./fs.env
pd=`pwd`
cd ..
top=`pwd`
cd $pd

	FS=$FSVolHome/$STACKATO_FILESYSTEM

		if test ! -d $FS
		 then
			mkdir $FS
		fi
 fi



ARCHIVE_CNT=${#SEDSTRS[@]}

#KLUDGE 
INSTALL_SCRIPT=install.php
CONFIGURED_FILE=$FS/config.php

#INSTALL_SCRIPT=config.sample.inc.php
echo dbname $dbname dbport $dbport dbuser $dbuser dbpass $dbpasswd dbhost $dbhost


echo  h $HOME s $SAR

cd  $SAR
#ls -lRa /usr/lib/php5

run=0
echo "Install $INSTALL_SCRIPT script"
if test ! -z  $INSTALL_SCRIPT
 then
        if test -f  $INSTALL_SCRIPT  
         then
           if  test -z $CONFIGURED_FILE 
            then
               run=1
                echo "Install $INSTALL_SCRIPT script found "
            elif  test ! -f $CONFIGURED_FILE
                then 
                        run=1
            fi
        fi
 fi
#ls

  echo "Configured $CONFIGURED_FILE file"
if test ! -z  $CONFIGURED_FILE
 then
        if test ! -f  $CONFIGURED_FILE
         then
           run=1
           echo "Configured $CONFIGURED_FILE file not found"
        fi
 fi

#FIX ME
#if   [ $run -ne 0 ]
# then
n=0
echo "performing substitutions"
        while test $n -lt $ARCHIVE_CNT
        do
          SED_STR=${SEDSTRS[$n]}
          SED_FILE=${SEDTARGETS[$n]}
        SED_TARGET=${SEDDSTS[$n]}

# cat $SED_FILE | sed --expression="$SED_STR"

          cat $SED_FILE | sed --expression="$SED_STR"  > t.config.$n
        echo "  cat $SED_FILE | sed "\"$SED_STR\"" > t.config.$n"

          cp t.config.$n  $SED_TARGET
          echo cp t.config.$n  $SED_TARGET

          n=`expr $n + 1`

        done
#fi


if ! [ -f $FS/$PERSISTANCE_CONFIGURED_FILE ]
  then
echo "no $PERSISTANCE_CONFIGURED_FILE  Creating and setting up persistance"
                for dir in $PERSISTANT_DIRS
                        do
        echo  mkdir -p $FS/$dir
                        mkdir -p $FS/$dir
                         cp -rp ./$dir/*  $FS/$dir
                        rm -r  ./$dir
                        ln -s $FS/$dir  .
		ls -l $FS/$dir
                        done
                 for file in $PERSISTANT_FILES
                        do
echo  cp $file  $FS/
                          cp $file  $FS/
                          rm $file
                         ln -s $FS/$file .

                        done
else

echo setting up persistance

if test ! -z  $INSTALL_SCRIPT -a ! -z $CONFIGURED_FILE
 then
        echo deleting install
        rm  $INSTALL_SCRIPT
fi

  for dir in $PERSISTANT_DIRS
             do
		
              rm -r  ./$dir

 		 echo "rm -r ./$dir ; ln -s $FS/$dir  ./$dir"
		ls $FS/$dir
		ls 
		if ! test -e  $dir
			then
              			ln -s $FS/$dir  .
		fi

        done

 for file in $PERSISTANT_FILES
              do
echo rm $file
echo ln -s $FS/$file . 
                   rm $file
                   ln -s $FS/$file .

                done

fi




if test -z $FRAMEWORK
        then
                FRAMEWORK=php
        fi



if test $FRAMEWORK = rails
	then


DATABASE_URL="mysql2://$dbuser:$dbpasswd@$dbhost/$dbname"

export DATABASE_URL
RAILS_ENV=production
export RAILS_ENV


echo "web: env DATABASE_URL=mysql2://$dbuser:$dbpasswd@$dbhost/$dbname bundle exec thin -p \$PORT  start

" > Procfile
echo "Procfile Written "
echo "env DATABASE_URL=mysql2://$dbuser:$dbpasswd@$dbhost/$dbname bundle exec thin -p \$PORT  start

" > Procfile.sh

echo "login: &login
  adapter: mysql2
  host: localhost
  username: root
  password:


development:
  database: publify_dev
  <<: *login

test:
  database: publify_tests
  <<: *login

production:
  database: publify
  <<: *login
" > config/database.yml

echo "config.database.yml  Written"

echo "gem 'thin'" >> Gemfile
cat Gemfile
echo "Thin added to Gemfile"

cat Gemfile | sed "/https/s//http/" >g
cp g Gemfile

echo running bundle standalone
bundle install --standalone

 bundle exec rake generate_secret_token



echo "running rake db:"
  bundle exec  rake db:create
  bundle exec  rake db:migrate
   bundle exec rake db:seed


fi
