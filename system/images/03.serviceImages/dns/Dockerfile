FROM  engines/servicebase:$release
RUN echo "Y" | adduser -q --disabled-password --home /var/cache/bind -uid 22009 bind

RUN apt-get -y update;\
	apt-get -y install bind9 ;\
	apt-get clean;\
    mkdir -p /var/lib/bind/engines;\
    mkdir -p /var/run/named

ADD named.conf.local /etc/bind/named.conf.local
ADD named.conf.default-zones.ad /etc/
ADD templates /etc/bind/templates

ADD engines.internal.domain /var/lib/bind/engines/engines.dnsrecords

RUN chown bind /var/run/named;\
	chown bind /var/lib/bind/engines;\
	/usr/sbin/dnssec-keygen -a HMAC-MD5 -b 128 -n HOST  -r /dev/urandom -n HOST DDNS_UPDATE;\
	mv *private ddns.private;\
	mv *key ddns.key;\
	key=`cat ddns.private |grep Key | cut -f2 -d" "`;\
	cp /etc/bind/templates/named.conf.default-zones.start /etc/bind/named.conf.default-zones;\
	echo "secret \"$key\";" >> /etc/bind/named.conf.default-zones;\
	cat /etc/bind/templates/named.conf.default-zones.end >> /etc/bind/named.conf.default-zones

COPY home home

#CMD /usr/sbin/named -c /etc/bind/named.conf -u bind -g

ENV ContUser bind
ENV ContGrp bind

CMD /home/init.sh