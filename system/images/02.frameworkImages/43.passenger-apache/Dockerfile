FROM engines/rails4

ENV RAILS_ENV production

RUN /usr/sbin/usermod -u 22671 www-data ;\
 	apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 561F9B9CAC40B2F7 ;\
	apt-get install -y apt-transport-https ca-certificates  apache2-threaded-dev libapr1-dev libaprutil1-dev ;\
	echo deb https://oss-binaries.phusionpassenger.com/apt/passenger trusty main  >/etc/apt/sources.list.d/passenger.list;\ 
	chmod 600 /etc/apt/sources.list.d/passenger.list;\
	apt-get update -y ;\
	apt-get install -y apache2 libapache2-mod-passenger passenger-dev;\
	a2enmod passenger;\
    rm etc/apache2/sites-enabled/*;\
	/usr/local/rbenv/shims/gem install passenger;\
    /usr/local/rbenv/shims/passenger-install-apache2-module -a --languages ruby,nodejs,python;\
	mkdir -p /var/log/apache2 ;\
	chown -R www-data /var/log/apache2 ;\
	a2enmod rewrite; \
 	mkdir -p /lock/apache2 ;\
 	chown www-data /run/lock/apache2
 	
ADD 000-default.conf /etc/apache2/sites-enabled/
ADD	passenger.conf  /etc/apache2/mods-enabled/
ADD ports.conf /etc/apache2/

ENV ContUser www-data
ENV ContGrp www-data

